import{z as O,A as R}from"./ui-BibPgP1I.js";import{d as X,e as $}from"./index-Btbp3Gjs.js";import{r as _,E as V,w as G,k as F,c as z,d as M,p as u,x as b,j as H,e as n,$ as p,F as K,N as L}from"./vendor-BOi6Gr0G.js";import P from"./ResumenTour-BaSYdCr8.js";import W from"./FormularioDatosPersonales-DIB5-7vf.js";import J from"./SelectorCupos-C2Ah9Je2.js";const Q={key:0,class:"space-y-3 sm:space-y-4 lg:space-y-6 text-xs sm:text-sm text-gray-700"},Y={class:"flex flex-row gap-3 sm:gap-4 pt-4 sm:pt-6 px-1 sm:px-0"},se={__name:"ModalReservaTour",props:{visible:{type:Boolean,default:!1},tourSeleccionado:{type:Object,default:null},user:{type:Object,default:null}},emits:["update:visible","confirmar-reserva","actualizar-cupos","refrescar-tour"],setup(d,{emit:N}){const c=O(),i=d,m=N,f=_(null),o=_({correo:"",nombres:"",tipo_documento:null,tipo_documento_id:null,numero_identificacion:"",fecha_nacimiento:"",genero:"",direccion:"",telefono:"",cupos_adultos:1,cupos_menores:0}),v=_(!1),A=async()=>{var a;if(!i.user)return null;try{const e=await fetch("/api/cliente-datos",{method:"GET",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":((a=document.querySelector('meta[name="csrf-token"]'))==null?void 0:a.getAttribute("content"))||"","X-Requested-With":"XMLHttpRequest"},credentials:"same-origin"});return e.ok?(await e.json()).cliente||null:(e.status===404||console.error("Error al cargar datos del cliente:",e.status),null)}catch(e){return console.error("Error al cargar datos del cliente:",e),null}},U=async()=>{const a=i.user;let e="",l="";if(a&&(l=a.email||"",e=a.name||""),o.value={correo:l,nombres:e,tipo_documento:null,tipo_documento_id:null,numero_identificacion:"",fecha_nacimiento:"",genero:"",direccion:"",telefono:"",cupos_adultos:1,cupos_menores:0},v.value=!1,a){const t=await A();if(t){v.value=!0;let r="";if(t.fecha_nacimiento)try{r=new Date(t.fecha_nacimiento)}catch{}o.value={...o.value,tipo_documento_id:t.tipo_documento_id,numero_identificacion:t.numero_identificacion||"",fecha_nacimiento:r,genero:t.genero||"",direccion:t.direccion||"",telefono:t.telefono||""}}}},g=()=>{m("update:visible",!1)},y=a=>{c.add(a)},q=async()=>{var a,e,l,t,r,x,w,h,C,S,E,T,j,k;if(!((a=f.value)!=null&&a.validateForm&&!f.value.validateForm())){if(o.value.cupos_adultos<=0&&o.value.cupos_menores<=0){c.add({severity:"error",summary:"Error en la reserva",detail:"Debe seleccionar al menos un cupo.",life:4e3});return}try{const s=await L.post("/reservas/tour",{tour_id:i.tourSeleccionado.id,cliente_data:{correo:o.value.correo,nombres:o.value.nombres,tipo_documento_id:o.value.tipo_documento_id||o.value.tipo_documento,numero_identificacion:o.value.numero_identificacion,fecha_nacimiento:o.value.fecha_nacimiento,genero:((e=o.value.genero)==null?void 0:e.toUpperCase())||"",direccion:o.value.direccion,telefono:o.value.telefono},cupos_adultos:o.value.cupos_adultos,cupos_menores:o.value.cupos_menores,precio_total:B.value.total});((t=(l=s.data)==null?void 0:l.data)==null?void 0:t.cupos_disponibles_actualizados)!==void 0&&m("actualizar-cupos",{tourId:i.tourSeleccionado.id,cuposDisponibles:s.data.data.cupos_disponibles_actualizados}),m("refrescar-tour",i.tourSeleccionado.id),m("confirmar-reserva",s.data),g()}catch(s){if(console.error("Error al confirmar reserva:",s),((r=s.response)==null?void 0:r.status)===419)c.add({severity:"error",summary:"Sesión expirada",detail:"Su sesión ha expirado. Por favor, recargue la página.",life:5e3}),window.location.reload();else if(((x=s.response)==null?void 0:x.status)===422){const I=((h=(w=s.response)==null?void 0:w.data)==null?void 0:h.errors)||{},D=Object.values(I).flat();D.length>0?c.add({severity:"error",summary:"Errores de validación",detail:D.join(", "),life:5e3}):c.add({severity:"error",summary:"Error de validación",detail:((S=(C=s.response)==null?void 0:C.data)==null?void 0:S.message)||"Datos inválidos",life:4e3})}else((E=s.response)==null?void 0:E.status)===403?c.add({severity:"error",summary:"Acceso denegado",detail:"No tiene permisos para realizar esta acción. Debe tener rol de cliente.",life:4e3}):((T=s.response)==null?void 0:T.status)===401?c.add({severity:"error",summary:"Sesión requerida",detail:"Debe iniciar sesión para realizar una reserva.",life:4e3}):c.add({severity:"error",summary:"Error al procesar la reserva",detail:((k=(j=s.response)==null?void 0:j.data)==null?void 0:k.message)||"Inténtelo de nuevo.",life:4e3})}}},B=V(()=>{if(!i.tourSeleccionado)return{total:0};const a=i.tourSeleccionado.precio||i.tourSeleccionado.precio_adulto||0,e=o.value.cupos_adultos+o.value.cupos_menores;return{total:a*e}});return G(()=>i.visible,async a=>{a&&await U()}),(a,e)=>{const l=F("Toast"),t=F("Dialog");return M(),z(K,null,[u(l),u(t,{visible:d.visible,"onUpdate:visible":e[3]||(e[3]=r=>m("update:visible",r)),modal:"",closable:!1,class:"w-[95vw] sm:w-[90vw] md:w-[85vw] lg:w-[80vw] xl:max-w-4xl mx-2 sm:mx-4",draggable:!1},{header:b(()=>e[4]||(e[4]=[n("h3",{class:"text-sm sm:text-base lg:text-lg font-bold text-red-700 flex items-center"},[n("span",{class:"mr-1 sm:mr-2"},"🧾"),n("span",{class:"hidden sm:inline"},"Reservando Tour"),n("span",{class:"sm:hidden"},"Reserva")],-1)])),footer:b(()=>[n("div",Y,[n("button",{onClick:g,type:"button",class:"bg-white hover:bg-red-50 text-red-600 border border-red-600 flex-1 sm:flex-none sm:px-6 px-3 py-3 sm:py-2 text-sm sm:text-base font-medium rounded-lg transition-all duration-200 ease-in-out flex items-center justify-center gap-2"},[u(p(R),{icon:p(X),class:"h-4 w-4 text-red-600"},null,8,["icon"]),e[5]||(e[5]=n("span",{class:"hidden sm:inline"},"Cancelar",-1)),e[6]||(e[6]=n("span",{class:"sm:hidden"},"Cancelar",-1))]),n("button",{onClick:q,type:"button",class:"bg-red-600 hover:bg-red-700 text-white border border-red-600 flex-1 sm:flex-none sm:px-6 px-3 py-3 sm:py-2 text-sm sm:text-base font-semibold rounded-lg transition-all duration-200 ease-in-out flex items-center justify-center gap-2 shadow-lg hover:shadow-xl"},[u(p(R),{icon:p($),class:"h-4 w-4 text-white"},null,8,["icon"]),e[7]||(e[7]=n("span",{class:"hidden sm:inline"},"Confirmar Reserva",-1)),e[8]||(e[8]=n("span",{class:"sm:hidden"},"Confirmar",-1))])])]),default:b(()=>[d.tourSeleccionado?(M(),z("div",Q,[u(P,{"tour-seleccionado":d.tourSeleccionado},null,8,["tour-seleccionado"]),u(W,{ref_key:"formularioDatosRef",ref:f,formulario:o.value,"onUpdate:formulario":e[0]||(e[0]=r=>o.value=r),"tiene-cliente-existente":v.value,user:d.user,onMostrarToast:y},null,8,["formulario","tiene-cliente-existente","user"]),u(J,{"cupos-adultos":o.value.cupos_adultos,"onUpdate:cuposAdultos":e[1]||(e[1]=r=>o.value.cupos_adultos=r),"cupos-menores":o.value.cupos_menores,"onUpdate:cuposMenores":e[2]||(e[2]=r=>o.value.cupos_menores=r),"tour-seleccionado":d.tourSeleccionado,onMostrarToast:y},null,8,["cupos-adultos","cupos-menores","tour-seleccionado"])])):H("",!0)]),_:1},8,["visible"])],64)}}};export{se as default};
