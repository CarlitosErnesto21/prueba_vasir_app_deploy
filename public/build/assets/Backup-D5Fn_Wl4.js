import{r as _,o as O,k as C,h as P,d as m,x as $,e,p as d,$ as t,a1 as K,q as x,y as Q,t as w,c as f,F as V,l as Y,N as y}from"./vendor-BOi6Gr0G.js";import{z as X,E as I,A as c}from"./ui-BibPgP1I.js";import{s as J,A as W}from"./AuthenticatedLayout-ySbiGZ3w.js";import{f as Z,p as L,q as A,r as N,s as ee,t as se,u as ae}from"./index-Btbp3Gjs.js";import"./logo-DN1bLr27.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";const te={class:"container mx-auto px-4 py-8"},oe={class:"bg-white rounded-lg shadow-lg overflow-hidden"},re={class:"bg-gradient-to-r from-red-600 to-red-700 px-6 py-4"},ne={class:"flex items-center justify-between"},ie={class:"flex items-center"},le={class:"text-2xl font-bold text-white flex items-center"},de={class:"p-6"},ce={class:"mb-8"},ue={class:"bg-blue-50 border border-blue-200 rounded-lg p-6"},pe={class:"space-y-6"},me={class:"flex space-x-4"},fe=["disabled"],ye=["disabled"],ge={class:"mb-8"},be={key:0,class:"text-center py-8 text-gray-500"},ve={key:1,class:"text-center py-8 text-gray-500"},he={key:2,class:"space-y-3"},xe={class:"flex items-center"},we={class:"font-medium text-gray-800"},ke={class:"text-sm text-gray-500"},_e={class:"flex space-x-2"},Ee=["onClick"],Be=["onClick"],g=3,Te={__name:"Backup",setup(Ce){const i=X(),E=I(),u=_(!1),k=_(!1),p=_([]),b=()=>({"X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').getAttribute("content"),Accept:"application/json","Content-Type":"application/json"}),v=async()=>{k.value=!0;try{const r=await y.get("/api/backups",{headers:b()});r.data.success?p.value=r.data.backups:i.add({severity:"error",summary:"Error",detail:r.data.message||"Error al cargar los backups",life:5e3})}catch(r){r.response?i.add({severity:"error",summary:"Error de Conexión",detail:`Error ${r.response.status}: ${r.response.data.message||"Error desconocido"}`,life:5e3}):i.add({severity:"error",summary:"Error de Red",detail:"No se pudo conectar con el servidor",life:5e3})}finally{k.value=!1}},D=async()=>{var r,s;if(u.value){i.add({severity:"warn",summary:"Backup en Proceso",detail:"Ya se está generando un backup. Por favor espere.",life:3e3});return}u.value=!0;try{i.add({severity:"info",summary:"Generando Backup",detail:"El proceso puede tomar unos minutos...",life:5e3});const l=await y.post("/api/backups/generate",{},{headers:b()});if(l.data.success)i.add({severity:"success",summary:"Backup Generado",detail:"El backup se ha generado correctamente.",life:4e3}),await v();else throw new Error(l.data.message||"Error al generar el backup")}catch(l){i.add({severity:"error",summary:"Error al Generar Backup",detail:((s=(r=l.response)==null?void 0:r.data)==null?void 0:s.message)||l.message||"Error desconocido",life:5e3})}finally{u.value=!1}},S=async r=>{try{const s=await y.get(`/api/backups/${r}/download`,{responseType:"blob"}),l=window.URL.createObjectURL(new Blob([s.data])),o=document.createElement("a");o.href=l;const n=s.headers["content-disposition"];let a="backup.zip";if(n){const h=n.match(/filename="(.+)"/);h&&(a=h[1])}o.setAttribute("download",a),document.body.appendChild(o),o.click(),o.remove(),window.URL.revokeObjectURL(l),i.add({severity:"success",summary:"Descarga Iniciada",detail:"El archivo se está descargando",life:3e3})}catch{i.add({severity:"error",summary:"Error de Descarga",detail:"No se pudo descargar el respaldo",life:5e3})}},j=r=>{const s=p.value.find(o=>o.id===r),l=s?s.name:`Backup ${r}`;E.require({message:`¿Está seguro de que desea eliminar el backup "${l}"? Esta acción no se puede deshacer.`,header:"Confirmar Eliminación",icon:"pi pi-exclamation-triangle",acceptClass:"p-button-danger",rejectClass:"p-button-outlined",acceptLabel:"Sí, Eliminar",rejectLabel:"Cancelar",accept:async()=>{var o,n;try{const a=await y.delete(`/api/backups/${r}`,{headers:b()});if(a.data.success)i.add({severity:"success",summary:"Backup Eliminado",detail:`El backup "${l}" ha sido eliminado correctamente.`,life:3e3}),await v();else throw new Error(a.data.message||"Error al eliminar el backup")}catch(a){i.add({severity:"error",summary:"Error al Eliminar",detail:((n=(o=a.response)==null?void 0:o.data)==null?void 0:n.message)||a.message||"Error desconocido",life:5e3})}}})},T=()=>{if(p.value.length===0){i.add({severity:"info",summary:"No Hay Nada Que Limpiar",detail:"No hay respaldos disponibles para limpiar.",life:3e3});return}if(p.value.length<=g){i.add({severity:"info",summary:"No Hay Nada Que Limpiar",detail:`Solo hay ${p.value.length} respaldo(s). Se mantienen automáticamente los últimos ${g}.`,life:3e3});return}const s=[...p.value].sort((o,n)=>{try{const a=o.date.split(" "),[h,R,G]=a[0].split("/"),q=a[1]||"00:00",z=new Date(`${G}-${R}-${h}T${q}`),B=n.date.split(" "),[F,U,H]=B[0].split("/"),M=B[1]||"00:00";return new Date(`${H}-${U}-${F}T${M}`)-z}catch(a){return console.warn("Error parsing backup dates, falling back to filename sort:",a),n.name.localeCompare(o.name)}}).slice(g);if(s.length===0){i.add({severity:"info",summary:"No Hay Nada Que Limpiar",detail:`Ya tienes solo los últimos ${g} respaldos.`,life:3e3});return}const l=s.map(o=>o.name).join(", ");E.require({message:`¿Está seguro de limpiar los respaldos antiguos? Se eliminarán ${s.length} respaldo(s): ${l}. Se mantendrán solo los últimos ${g}. Esta acción no se puede deshacer.`,header:"Confirmar Limpieza",rejectLabel:"Cancelar",acceptLabel:"Sí, Limpiar",rejectClass:"p-button-secondary p-button-outlined",acceptClass:"p-button-warning",accept:async()=>{var o,n;try{const a=await y.post("/api/backups/cleanup",{},{headers:b()});if(a.data.success)i.add({severity:"success",summary:"Limpieza Completada",detail:`Se han eliminado ${s.length} respaldo(s) antiguos.`,life:4e3}),await v();else throw new Error(a.data.message||"Error al limpiar los backups")}catch(a){i.add({severity:"error",summary:"Error al Limpiar",detail:((n=(o=a.response)==null?void 0:o.data)==null?void 0:n.message)||a.message||"Error desconocido",life:5e3})}}})};return O(()=>{v()}),(r,s)=>{const l=C("Toast"),o=C("ConfirmDialog");return m(),P(W,null,{default:$(()=>[e("div",te,[e("div",oe,[e("div",re,[e("div",ne,[e("div",ie,[d(t(K),{href:t(J)("settings"),class:"flex items-center text-white hover:text-red-200 transition-colors duration-200 p-2 rounded-lg hover:bg-red-800 mr-4",title:"Regresar a configuración"},{default:$(()=>[d(t(c),{icon:t(Z),class:"h-5 w-5"},null,8,["icon"])]),_:1},8,["href"]),e("div",null,[e("h1",le,[d(t(c),{icon:t(L),class:"mr-3"},null,8,["icon"]),s[0]||(s[0]=x(" Respaldo de Base de Datos "))]),s[1]||(s[1]=e("p",{class:"text-red-100 mt-2"},"Genere y gestione copias de seguridad de la base de datos",-1))])])])]),e("div",de,[e("div",ce,[s[4]||(s[4]=e("h2",{class:"text-xl font-semibold text-gray-800 mb-4 flex items-center"},[e("span",{class:"text-2xl mr-2"},"💾"),x(" Gestión Manual de Respaldos ")],-1)),e("div",ue,[e("div",pe,[s[3]||(s[3]=e("div",{class:"bg-white border rounded-lg p-4"},[e("div",{class:"flex items-center justify-between"},[e("div",{class:"flex items-center"},[e("div",{class:"bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm font-medium mr-3"}," 🔧 Manual "),e("span",{class:"text-gray-700 font-medium"}," Respaldos bajo demanda ")])])],-1)),e("div",me,[e("button",{onClick:D,disabled:u.value,class:"bg-red-600 hover:bg-red-700 disabled:bg-gray-400 text-white font-semibold py-3 px-6 rounded-lg flex items-center transition-colors duration-200"},[d(t(c),{icon:u.value?t(A):t(N),class:Q([{"animate-spin":u.value},"mr-2"])},null,8,["icon","class"]),x(" "+w(u.value?"Generando...":"Generar Respaldo"),1)],8,fe),e("button",{onClick:T,disabled:u.value,class:"bg-yellow-600 hover:bg-yellow-700 disabled:bg-gray-400 text-white font-semibold py-3 px-6 rounded-lg flex items-center transition-colors duration-200"},[d(t(c),{icon:t(ee),class:"mr-2"},null,8,["icon"]),s[2]||(s[2]=x(" Limpiar Antiguos "))],8,ye)])])])]),e("div",ge,[s[7]||(s[7]=e("h2",{class:"text-xl font-semibold text-gray-800 mb-4"},"Respaldos Disponibles",-1)),k.value?(m(),f("div",be,[d(t(c),{icon:t(A),class:"text-4xl mb-2 animate-spin"},null,8,["icon"]),s[5]||(s[5]=e("p",null,"Cargando respaldos...",-1))])):p.value.length===0?(m(),f("div",ve,[d(t(c),{icon:t(se),class:"text-4xl mb-2"},null,8,["icon"]),s[6]||(s[6]=e("p",null,"No hay respaldos disponibles",-1))])):(m(),f("div",he,[(m(!0),f(V,null,Y(p.value,n=>(m(),f("div",{key:n.id,class:"flex items-center justify-between p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors duration-200"},[e("div",xe,[d(t(c),{icon:t(L),class:"text-red-600 mr-3"},null,8,["icon"]),e("div",null,[e("h3",we,w(n.name),1),e("p",ke,w(n.date)+" - "+w(n.size),1)])]),e("div",_e,[e("button",{onClick:a=>S(n.id),class:"text-blue-600 hover:text-blue-800 p-2 rounded-full hover:bg-blue-50 transition-colors duration-200",title:"Descargar"},[d(t(c),{icon:t(N)},null,8,["icon"])],8,Ee),e("button",{onClick:a=>j(n.id),class:"text-red-600 hover:text-red-800 p-2 rounded-full hover:bg-red-50 transition-colors duration-200",title:"Eliminar"},[d(t(c),{icon:t(ae)},null,8,["icon"])],8,Be)])]))),128))]))])])])]),d(l),d(o,{style:{width:"450px"},breakpoints:{"1199px":"75vw","575px":"90vw"}})]),_:1})}}};export{Te as default};
